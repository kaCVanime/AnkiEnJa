<div id=deck deck_name="{{Deck}}"></div>
<div class="root">
  <header>
    <h2 id="term" class="center">{{term}}</h2>
    <div class="center">
      <span class="phonetic BrEPhonetic italic hide">{{BrEPhonetic}}</span>
      <span class="phonetic AmEPhonetic italic">{{AmEPhonetic}}</span>
    </div>
    <div class="center italic label mt-10">{{label}}</div>
    <div class="center italic label mt-10">{{usage}}</div>
  </header>
  <main>
    <div id="eg-box"></div>

    <div id="error" class="hide"></div>
  </main>

</div>
<script>
  var labelsNeedOrNot = {
    BrE: false,
    AmE: true,
    informal: true,
    formal: true,
    "old-fashioned": true,
    humorous: true,
  };

  var examplesJson = `{{examples}}`

  var egBoxEl = document.getElementById("eg-box")
  var errEl = document.getElementById("error")

  var removeItemThatHasLabelOf = Object.keys(labelsNeedOrNot).filter(
    (label) => !labelsNeedOrNot[label]
  );

  function parseJson(json) {
    try {
      const data = JSON.parse(json)
      return data
    } catch (e) {
      return undefined
    }
  }

  function filterLabels(data=[], excludeLabels=[]) {
    const result = data.filter(item => !item.label || !excludeLabels.some((label) => item.label.indexOf(label) > -1))
    return result.length ? result : data
  }

   function addSpanElements(parent, content, classlist = []) {
    if (!content) return parent;
    const el = document.createElement("span");
    el.textContent = content
    el.classList.add(...classlist);
    parent.appendChild(el)
    return el
  }

  function addLabel(parent, content) {
    return addSpanElements(parent, content, ["label", "italic"])
  }

  function addUsage(parent, content) {
    return addSpanElements(parent, content, ["usage"])
  }

  function addContent(parent, content) {
    return addSpanElements(parent, content, ["content"])
  }

  function makeElement(item) {
    if (!item) return;
    const div = document.createElement("div")
    if (item.label) addLabel(div, item.label)
    if (item.usage) addUsage(div, item.usage)
    addContent(div, item.en)
    return div
  }

  // https://stackoverflow.com/questions/19269545/how-to-get-a-number-of-random-elements-from-an-array
  function getRandom(arr, n) {
    if (!arr.length) return [];
    if (n > arr.length) n = arr.length;

    var result = new Array(n),
      len = arr.length,
      taken = new Array(len);

    while (n--) {
      var x = Math.floor(Math.random() * len);
      result[n] = arr[x in taken ? taken[x] : x];
      taken[x] = --len in taken ? taken[len] : len;
    }
    return result;
  }

  function addRandomExample() {
    console.log(examplesJson)
    const exampleData = parseJson(examplesJson) || []
    console.log(exampleData)
    const filtered = filterLabels(exampleData, removeItemThatHasLabelOf)
    console.log(filtered)
    const picked = getRandom(filtered, 1)[0]
    const exampleEl = makeElement(picked)
    if (exampleEl) {
      egBoxEl.appendChild(exampleEl)
      localStorage.setItem("KEXP_READ", picked.name)
    } else {
      localStorage.removeItem("KEXP_READ")
    }
  }

  try {
    addRandomExample()
  } catch (err) {
    console.log(err);
    errEl.classList.remove('hide')
    errEl.textContent = err;
  }


</script>